var Barrister;Barrister||(Barrister={}),function(){function randstr(len){var i,s="";for(i=0;len>i;i++){var rnum=Math.floor(Math.random()*rchars.length);s+=rchars.substring(rnum,rnum+1)}return s}function JSON_stringify(s,emit_unicode){if(s){var json=JSON.stringify(s);return json?emit_unicode?json:json.replace(jsonRegex,jsonRegexReplace):json}return s}function makeRequest(method,params){var req={jsonrpc:"2.0",id:randstr(20),method:method};return null!==params&&void 0!==params&&(req.params=params),req}function errResp(id,code,msg,data){return id=id||null,{jsonrpc:"2.0",id:id,error:{code:code,message:msg,data:data}}}function parseResponse(req,error,body){var resp;if(error)resp=errResp(req.id,-32e3,error);else if(void 0!==body&&null!==body)if("object"==typeof body)resp=body;else try{resp=JSON.parse(body)}catch(e){resp=errResp(req.id,-32700,"Unable to parse response JSON: "+body)}else resp=errResp(req.id,-32603,"Null response body received from server");return resp}function defaultCoerce(expectedType,val){var x,type;if(null===val||void 0===val)return val;if(type=typeof val,"boolean"===type||"number"===type){if("string"===expectedType)return val.toString()}else if("string"===type)if("bool"===expectedType){if("true"===val)return!0;if("false"===val)return!1}else if("int"===expectedType){if(x=parseInt(val,10),x.toString()===val&&"NaN"!==val)return x}else if("float"===expectedType&&(x=parseFloat(val),x.toString()===val&&"NaN"!==val))return x;return val}function Promise(){var me=this;this.errCallback=null,this.resultCallback=null,this.callbackInvoked=!1,this.respReceived=!1,this.callback=function(err,result){me.err=err,me.result=result,me.respReceived=!0,me._triggerCallback()}}function Contract(idl,coerce){var i,x,e,f;for(this.idl=idl,this.coerce=coerce,this.interfaces={},this.functions={},this.structs={},this.enums={},this.meta={},i=0;i<idl.length;i++)if(e=idl[i],"interface"===e.type)for(this.interfaces[e.name]=e,x=0;x<e.functions.length;x++)f=e.functions[x],this.functions[e.name+"."+f.name]=f;else if("struct"===e.type)this.structs[e.name]=e;else if("enum"===e.type)this.enums[e.name]=e;else if("meta"===e.type)for(x in e)e.hasOwnProperty(x)&&"type"!==x&&(this.meta[x]=e[x])}function Batch(client){this.client=client,this.reqList=[]}function Client(transport,opts){this.transport=transport,this.trace=null,this.coerce=null,this.validateRequest=!0,opts&&opts.coerce&&(opts.coerce===!0?this.coerce=defaultCoerce:"function"==typeof opts.coerce&&(this.coerce=opts.coerce))}var rchars="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",jsonRegex=new RegExp("[\\u007f-\\uffff]","g"),jsonRegexReplace=function(c){return"\\u"+("0000"+c.charCodeAt(0).toString(16)).slice(-4)};Promise.prototype.error=function(callback,context){return this.errCallback=callback,this.errContext=context,this._triggerCallback(),this},Promise.prototype.success=function(callback,context){return this.resultCallback=callback,this.resultContext=context,this._triggerCallback(),this},Promise.prototype._triggerCallback=function(){this.callbackInvoked||(this.respReceived&&this.err?this.errCallback&&(this.callbackInvoked=!0,this.errContext?this.errCallback.call(this.errContext,this.err):this.errCallback(this.err)):this.respReceived&&this.resultCallback&&(this.callbackInvoked=!0,this.resultContext?this.resultCallback.call(this.resultContext,this.result):this.resultCallback(this.result)))},Contract.prototype.coerceRecursive=function(expectedType,isArray,val){var t,fields,e,i,me=this;if(me.coerce&&null!==val&&void 0!==val){if(t=typeof val,isArray===!0){if("object"!==t||!val instanceof Array)return val;for(i=0;i<val.length;i++)val[i]=me.coerceRecursive(expectedType,!1,val[i]);return val}if("string"===expectedType||"bool"===expectedType||"int"===expectedType||"float"===expectedType)return me.coerce(expectedType,val);if(me.structs[expectedType]){if("object"!==t)return val;for(fields=me.getAllStructFields([],me.structs[expectedType]),i=0;i<fields.length;i++)e=fields[i],val[e.name]=me.coerceRecursive(e.type,e.is_array,val[e.name]);return val}}return val},Contract.prototype.validate=function(namePrefix,expected,isArray,val){var i,e,fields,fieldKeys,valid,me=this,okRes=[!0,null];if(namePrefix=namePrefix||"",null===val||void 0===val)return expected.optional===!0?okRes:[!1,namePrefix+" cannot be null"];var t=typeof val;if(isArray===!0){if("object"!==t||!val instanceof Array)return me.validationErr(namePrefix,"[]"+expected.type,t,val);for(i=0;i<val.length;i++)if(valid=me.validate(namePrefix+"["+i+"]",expected,!1,val[i]),!valid[0])return valid;return okRes}if("string"===expected.type)return"string"===t?okRes:me.validationErr(namePrefix,expected.type,t,val);if("bool"===expected.type)return"boolean"===t?okRes:me.validationErr(namePrefix,expected.type,t,val);if("int"===expected.type||"float"===expected.type)return"number"!==t?me.validationErr(namePrefix,expected.type,t,val):"int"===expected.type&&val%1!==0?me.validationErr(namePrefix,expected.type,"float",val):okRes;if(me.structs[expected.type]){if("object"!==t)return me.validationErr(namePrefix,expected.type,t,val);for(fields=me.getAllStructFields([],me.structs[expected.type]),fieldKeys={},i=0;i<fields.length;i++){if(e=fields[i],valid=me.validate(namePrefix+"."+e.name,e,e.is_array,val[e.name]),!valid[0])return valid;fieldKeys[e.name]=1}for(i in val)if(val.hasOwnProperty(i)&&!fieldKeys[i])return[!1,namePrefix+"."+i+" does not exist in type '"+expected.type+"'"];return okRes}if(me.enums[expected.type]){if("string"!==t)return me.validationErr(namePrefix,expected.type,t,val);for(e=me.enums[expected.type],i=0;i<e.values.length;i++)if(e.values[i].value===val)return okRes;var msg=namePrefix+" value '"+val+"' is not in the enum '"+e.name+"': "+JSON.stringify(e.values);return[!1,msg]}return[!1,namePrefix+" unknown type: "+expected.type]},Contract.prototype.validateReq=function(req){if("barrister-idl"===req.method)return null;var func=this.functions[req.method];if(!func)return errResp(req.id,-32601,"Method not found: "+req.method);var i,valid,msg,paramLen=req.params?req.params.length:0;if(paramLen!==func.params.length)return msg="Param length: "+paramLen+" != expected length: "+func.params.length,errResp(req.id,-32602,msg);for(i=0;i<func.params.length;i++)if(valid=this.validate(func.params[i].name,func.params[i],func.params[i].is_array,req.params[i]),valid[0]||(req.params[i]=this.coerceRecursive(func.params[i].type,func.params[i].is_array,req.params[i]),valid=this.validate(func.params[i].name,func.params[i],func.params[i].is_array,req.params[i])),!valid[0])return msg="Invalid request param["+i+"]: "+valid[1],errResp(req.id,-32602,msg);return null},Contract.prototype.validateResp=function(req,resp){if(!resp.result||"barrister-idl"===req.method)return resp;var func=this.functions[req.method];if(!func)return errResp(req.id,-32601,"Method not found: "+req.method);var valid=this.validate("",func.returns,func.returns.is_array,resp.result);if(valid[0])return resp;var msg="Invalid response for "+req.method+": "+valid[1];return"undefined"!=typeof console&&console.log&&console.log("ERROR: "+msg),errResp(req.id,-32001,msg)},Contract.prototype.getAllStructFields=function(fields,struct){return struct.fields.length>0&&(fields=fields.concat(struct.fields)),struct["extends"]?this.getAllStructFields(fields,this.structs[struct["extends"]]):fields},Contract.prototype.validationErr=function(namePrefix,expType,actType,val){return[!1,namePrefix+" expects type '"+expType+"' but got type '"+actType+"' for value: "+val]},Batch.prototype.proxy=function(ifaceName){var me=this;return me.client._proxy(function(method){return me._functionProxy(method)},ifaceName)},Batch.prototype.request=function(method,params){this.reqList.push(makeRequest(method,params))},Batch.prototype._functionProxy=function(method){var client=this;return function(){var args=Array.prototype.slice.call(arguments);client.request(method,args)}},Batch.prototype.send=function(callback){var i,r,errObj,me=this,idToResp={},reqList=[];for(i=0;i<me.reqList.length;i++)r=me.reqList[i],me.client.validateRequest?(errObj=me.client.contract.validateReq(r),errObj?idToResp[r.id]=errObj:reqList.push(r)):reqList.push(r);var genResponseArr=function(reqList,idToResp){var respObj,respList=[];for(i=0;i<reqList.length;i++)reqList[i].id&&(r=idToResp[reqList[i].id],r?(r=me.wrapResp(reqList[i],r),respObj=r.error?{error:r.error}:{result:r.result}):(msg="No response received for request id: "+reqList[i].id,respObj={error:me.wrapResp(reqList[i],errResp(-32603,msg))}),respList.push(me.wrapResp(reqList[i],respObj)));return respList};return 0===reqList.length?void callback(null,genResponseArr(me.reqList,idToResp)):void me.client._send(reqList,function(resp){if(null!==resp&&void 0!==resp&&resp instanceof Array){var i,r;for(i=0;i<resp.length;i++)r=resp[i],r.id&&(idToResp[r.id]=r);callback(null,genResponseArr(me.reqList,idToResp))}else callback(resp,null)})},Batch.prototype.wrapResp=function(req,resp){return resp.method=req.method,resp.params=req.params,resp},Client.prototype.loadContract=function(callback){var me=this,promise=null;return callback||(promise=new Promise,callback=promise.callback),me.request("barrister-idl",[],function(err,result){err?callback(err):(me.contract=new Contract(result,me.coerce),callback(null,result))}),promise},Client.prototype.getMeta=function(){return this.contract.meta},Client.prototype.enableTrace=function(logFunc){this.trace=logFunc&&"function"==typeof logFunc?logFunc:function(s){console.log(s)}},Client.prototype.disableTrace=function(){this.trace=null},Client.prototype.startBatch=function(){return new Batch(this)},Client.prototype.proxy=function(ifaceName){var me=this;return me._proxy(function(method){return me._functionProxy(method)},ifaceName)},Client.prototype._proxy=function(funcProxyCreator,ifaceName){var me=this;if(!me.contract)throw"Contract.loadContract() has not been called yet!";var iface=me.contract.interfaces[ifaceName];if(iface){var i,func,proxy={};for(i=0;i<iface.functions.length;i++)func=iface.functions[i],proxy[func.name]=funcProxyCreator(ifaceName+"."+func.name);return proxy}throw"Interface not found: "+ifaceName},Client.prototype._functionProxy=function(method){var client=this;return function(){var callback=null,lastArg=null,promise=null,args=Array.prototype.slice.call(arguments);if(arguments.length>0&&(lastArg=arguments[arguments.length-1],void 0!==lastArg&&null!==lastArg&&"function"==typeof lastArg&&(callback=args.pop())),callback||(promise=new Promise,callback=promise.callback),void 0===callback||null===callback||"function"!=typeof callback)throw"Last arg to "+method+" must be a callback function!";return client.request(method,args,callback),promise}},Client.prototype.request=function(method,params,callback){var me=this,req=makeRequest(method,params);if(me.validateRequest&&me.contract){var err=me.contract.validateReq(req);if(err)return void callback(err.error,null)}me._send(req,function(resp){resp.error?callback(resp.error,null):callback(null,resp.result)})},Client.prototype._send=function(req,callback){var me=this;me.trace&&me.trace("Request: "+JSON_stringify(req)),me.transport(req,function(resp){me.trace&&me.trace("Response: "+JSON_stringify(resp)),callback(resp)})};var getCookie=function(name){var cookieValue=null;if(document.cookie&&""!==document.cookie)for(var cookies=document.cookie.split(";"),i=0;i<cookies.length;i++){var cookie=jQuery.trim(cookies[i]);if(cookie.substring(0,name.length+1)===name+"="){cookieValue=decodeURIComponent(cookie.substring(name.length+1));break}}return cookieValue},httpClient=function(o,clientOpts,httpOpts){var transport=o;return"string"==typeof o&&(transport=function(req,callback){var settings={type:"POST",contentType:"application/json",data:JSON_stringify(req),converters:{"text json":function(data){return parseResponse(req,null,data)}},error:function(jqXHR,textStatus,errorThrown){var resp;resp=jqXHR&&0===jqXHR.status?errResp(req.id,-32002,"HTTP request aborted",jqXHR):parseResponse(req,textStatus+" "+errorThrown,null),httpOpts&&httpOpts.onError&&httpOpts.onError(jqXHR,textStatus,errorThrown,resp),callback(resp)},success:function(data,textStatus,jqXHR){var resp=parseResponse(req,null,data);httpOpts&&httpOpts.onSuccess&&httpOpts.onSuccess(data,textStatus,jqXHR,resp),callback(resp)}},xsrfToken=getCookie("Xsrf-Token");xsrfToken&&(settings.headers={"X-Xsrf-Token":xsrfToken}),jQuery.ajax(o,settings)}),new Client(transport,clientOpts)};Barrister.httpClient=httpClient,Barrister.parseResponse=parseResponse,Barrister.Client=Client,Barrister.Contract=Contract,Barrister.Promise=Promise,Barrister.JSON_stringify=JSON_stringify}();