var Barrister;Barrister||(Barrister={}),function(){function b(b){var c="",d;for(d=0;d<b;d++){var e=Math.floor(Math.random()*a.length);c+=a.substring(e,e+1)}return c}function e(a,b){if(a){var e=JSON.stringify(a);return e?b?e:e.replace(c,d):e}return a}function f(a,c){var d={jsonrpc:"2.0",id:b(20),method:a};return c!==null&&c!==undefined&&(d.params=c),d}function g(a,b,c,d){return a=a||null,{jsonrpc:"2.0",id:a,error:{code:b,message:c,data:d}}}function h(a,b,c){var d;if(b)d=g(a.id,-32e3,b);else if(c!==undefined&&c!==null)if(typeof c=="object")d=c;else try{d=JSON.parse(c)}catch(e){d=g(a.id,-32700,"Unable to parse response JSON: "+c)}else d=g(a.id,-32603,"Null response body received from server");return d}function i(a,b){var c,d;if(b===null||b===undefined)return b;d=typeof b;if(d==="boolean"||d==="number"){if(a==="string")return b.toString()}else if(d==="string")if(a==="bool"){if(b==="true")return!0;if(b==="false")return!1}else if(a==="int"){c=parseInt(b,10);if(c.toString()===b&&b!=="NaN")return c}else if(a==="float"){c=parseFloat(b);if(c.toString()===b&&b!=="NaN")return c}return b}function j(){var a=this;this.errCallback=null,this.resultCallback=null,this.callbackInvoked=!1,this.respReceived=!1,this.callback=function(b,c){a.err=b,a.result=c,a.respReceived=!0,a._triggerCallback()}}function k(a,b){var c,d,e,f;this.idl=a,this.coerce=b,this.interfaces={},this.functions={},this.structs={},this.enums={},this.meta={};for(c=0;c<a.length;c++){e=a[c];if(e.type==="interface"){this.interfaces[e.name]=e;for(d=0;d<e.functions.length;d++)f=e.functions[d],this.functions[e.name+"."+f.name]=f}else if(e.type==="struct")this.structs[e.name]=e;else if(e.type==="enum")this.enums[e.name]=e;else if(e.type==="meta")for(d in e)e.hasOwnProperty(d)&&d!=="type"&&(this.meta[d]=e[d])}}function l(a){this.client=a,this.reqList=[]}function m(a,b){this.transport=a,this.trace=null,this.coerce=null,this.validateRequest=!0,b&&b.coerce&&(b.coerce===!0?this.coerce=i:typeof b.coerce=="function"&&(this.coerce=b.coerce))}var a="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",c=new RegExp("[\\u007f-\\uffff]","g"),d=function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)};j.prototype.error=function(a,b){return this.errCallback=a,this.errContext=b,this._triggerCallback(),this},j.prototype.success=function(a,b){return this.resultCallback=a,this.resultContext=b,this._triggerCallback(),this},j.prototype._triggerCallback=function(){if(this.callbackInvoked)return;this.respReceived&&this.err?this.errCallback&&(this.callbackInvoked=!0,this.errContext?this.errCallback.call(this.errContext,this.err):this.errCallback(this.err)):this.respReceived&&this.resultCallback&&(this.callbackInvoked=!0,this.resultContext?this.resultCallback.call(this.resultContext,this.result):this.resultCallback(this.result))},k.prototype.coerceRecursive=function(a,b,c){var d=this,e,f,g,h;if(d.coerce&&c!==null&&c!==undefined){e=typeof c;if(b===!0){if(e!=="object"||!c instanceof Array)return c;for(h=0;h<c.length;h++)c[h]=d.coerceRecursive(a,!1,c[h]);return c}if(a==="string"||a==="bool"||a==="int"||a==="float")return d.coerce(a,c);if(d.structs[a]){if(e!=="object")return c;f=d.getAllStructFields([],d.structs[a]);for(h=0;h<f.length;h++)g=f[h],c[g.name]=d.coerceRecursive(g.type,g.is_array,c[g.name]);return c}}return c},k.prototype.validate=function(a,b,c,d){var e=this,f,g,h,i,j,k,l=[!0,null];a=a||"";if(d===null||d===undefined)return b.optional===!0?l:[!1,a+" cannot be null"];var m=typeof d;if(c===!0){if(m!=="object"||!d instanceof Array)return e.validationErr(a,"[]"+b.type,m,d);for(f=0;f<d.length;f++){j=e.validate(a+"["+f+"]",b,!1,d[f]);if(!j[0])return j}return l}if(b.type==="string")return m==="string"?l:e.validationErr(a,b.type,m,d);if(b.type==="bool")return m==="boolean"?l:e.validationErr(a,b.type,m,d);if(b.type==="int"||b.type==="float")return m!=="number"?e.validationErr(a,b.type,m,d):b.type==="int"&&d%1!==0?e.validationErr(a,b.type,"float",d):l;if(e.structs[b.type]){if(m!=="object")return e.validationErr(a,b.type,m,d);h=e.getAllStructFields([],e.structs[b.type]),i={};for(f=0;f<h.length;f++){g=h[f],j=e.validate(a+"."+g.name,g,g.is_array,d[g.name]);if(!j[0])return j;i[g.name]=1}for(f in d)if(d.hasOwnProperty(f)&&!i[f])return[!1,a+"."+f+" does not exist in type '"+b.type+"'"];return l}if(e.enums[b.type]){if(m!=="string")return e.validationErr(a,b.type,m,d);g=e.enums[b.type];for(f=0;f<g.values.length;f++)if(g.values[f].value===d)return l;var n=a+" value '"+d+"' is not in the enum '"+g.name+"': "+JSON.stringify(g.values);return[!1,n]}return[!1,a+" unknown type: "+b.type]},k.prototype.validateReq=function(a){if(a.method==="barrister-idl")return null;var b=this.functions[a.method];if(!b)return g(a.id,-32601,"Method not found: "+a.method);var c=a.params?a.params.length:0,d,e,f;if(c!==b.params.length)return f="Param length: "+c+" != expected length: "+b.params.length,g(a.id,-32602,f);for(d=0;d<b.params.length;d++){e=this.validate(b.params[d].name,b.params[d],b.params[d].is_array,a.params[d]),e[0]||(a.params[d]=this.coerceRecursive(b.params[d].type,b.params[d].is_array,a.params[d]),e=this.validate(b.params[d].name,b.params[d],b.params[d].is_array,a.params[d]));if(!e[0])return f="Invalid request param["+d+"]: "+e[1],g(a.id,-32602,f)}return null},k.prototype.validateResp=function(a,b){if(!b.result||a.method==="barrister-idl")return b;var c=this.functions[a.method];if(!c)return g(a.id,-32601,"Method not found: "+a.method);var d=this.validate("",c.returns,c.returns.is_array,b.result);if(!d[0]){var e="Invalid response for "+a.method+": "+d[1];return typeof console!="undefined"&&console.log&&console.log("ERROR: "+e),g(a.id,-32001,e)}return b},k.prototype.getAllStructFields=function(a,b){return b.fields.length>0&&(a=a.concat(b.fields)),b["extends"]?this.getAllStructFields(a,this.structs[b["extends"]]):a},k.prototype.validationErr=function(a,b,c,d){return[!1,a+" expects type '"+b+"' but got type '"+c+"' for value: "+d]},l.prototype.proxy=function(a){var b=this;return b.client._proxy(function(a){return b._functionProxy(a)},a)},l.prototype.request=function(a,b){this.reqList.push(f(a,b))},l.prototype._functionProxy=function(a){var b=this;return function(){var c=Array.prototype.slice.call(arguments);b.request(a,c)}},l.prototype.send=function(a){var b=this,c,d,e,f={},h=[];for(c=0;c<b.reqList.length;c++)d=b.reqList[c],b.client.validateRequest?(e=b.client.contract.validateReq(d),e?f[d.id]=e:h.push(d)):h.push(d);var i=function(a,e){var f=[],h;for(c=0;c<a.length;c++)a[c].id&&(d=e[a[c].id],d?(d=b.wrapResp(a[c],d),d.error?h={error:d.error}:h={result:d.result}):(msg="No response received for request id: "+a[c].id,h={error:b.wrapResp(a[c],g(-32603,msg))}),f.push(b.wrapResp(a[c],h)));return f};if(h.length===0){a(null,i(b.reqList,f));return}b.client._send(h,function(c){if(c!==null&&c!==undefined&&c instanceof Array){var d=[],e,g,h;for(e=0;e<c.length;e++)g=c[e],g.id&&(f[g.id]=g);a(null,i(b.reqList,f))}else a(c,null)})},l.prototype.wrapResp=function(a,b){return b.method=a.method,b.params=a.params,b},m.prototype.loadContract=function(a){var b=this,c=null,d=null;return a||(d=new j,a=d.callback),b.request("barrister-idl",[],function(c,d){c?a(c):(b.contract=new k(d,b.coerce),a(null,d))}),d},m.prototype.getMeta=function(){return this.contract.meta},m.prototype.enableTrace=function(a){a&&typeof a=="function"?this.trace=a:this.trace=function(a){console.log(a)}},m.prototype.disableTrace=function(){this.trace=null},m.prototype.startBatch=function(){return new l(this)},m.prototype.proxy=function(a){var b=this;return b._proxy(function(a){return b._functionProxy(a)},a)},m.prototype._proxy=function(a,b){var c=this;if(!c.contract)throw"Contract.loadContract() has not been called yet!";var d=c.contract.interfaces[b];if(d){var e={},f,g;for(f=0;f<d.functions.length;f++)g=d.functions[f],e[g.name]=a(b+"."+g.name);return e}throw"Interface not found: "+b},m.prototype._functionProxy=function(a){var b=this;return function(){var c=null,d=null,e=null,f=Array.prototype.slice.call(arguments);arguments.length>0&&(d=arguments[arguments.length-1],d!==undefined&&d!==null&&typeof d=="function"&&(c=f.pop())),c||(e=new j,c=e.callback);if(c===undefined||c===null||typeof c!="function")throw"Last arg to "+a+" must be a callback function!";return b.request(a,f,c),e}},m.prototype.request=function(a,b,c){var d=this,e=f(a,b);if(d.validateRequest&&d.contract){var g=d.contract.validateReq(e);if(g){c(g.error,null);return}}d._send(e,function(a){a.error?c(a.error,null):c(null,a.result)})},m.prototype._send=function(a,b){var c=this;c.trace&&c.trace("Request: "+e(a)),c.transport(a,function(a){c.trace&&c.trace("Response: "+e(a)),b(a)})};var n=function(a,b){var c=function(b,c){a.handle({},b,c)};return new m(c,b)},o=function(a,b,c){var d=a;return typeof a=="string"&&(d=function(b,d){var f={type:"POST",contentType:"application/json",data:e(b),converters:{"text json":function(a){return h(b,null,a)}},error:function(a,e,f){var i;a&&a.status===0?i=g(b.id,-32002,"HTTP request aborted",a):i=h(b,e+" "+f,null),c&&c.onError&&c.onError(a,e,f,i),d(i)},success:function(a,e,f){var g=h(b,null,a);c&&c.onSuccess&&c.onSuccess(a,e,f,g),d(g)}};jQuery.ajax(a,f)}),new m(d,b)};Barrister.httpClient=o,Barrister.parseResponse=h,Barrister.Client=m,Barrister.Contract=k,Barrister.Promise=j,Barrister.JSON_stringify=e}();